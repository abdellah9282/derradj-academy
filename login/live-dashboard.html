<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ | Derradj Academy</title>
  <link rel="stylesheet" href="live-dashboard.css">
  <link rel="icon" type="image/jpeg" href="../Logo.jpg" />
</head>
<body>

  <div class="dashboard-container">
    <h2>ğŸ“ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ â€“ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h2>
    <p id="welcome"></p>

    <div id="session-info" class="info"></div>

    <div id="session-status"></div>

    <div id="links-section"></div>

    <button id="refresh" class="btn">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©</button>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ğŸ§© Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù…ÙŠÙ„ Supabase
  const supabase = window.supabase.createClient(
    "https://sgcypxmnlyiwljuqvcup.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNnY3lweG1ubHlpd2xqdXF2Y3VwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3OTI0MTEsImV4cCI6MjA2NDM2ODQxMX0.iwIikgvioT06uPoXES5IN98TwhtePknCuEQ5UFohfCM"
  );

  // ğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
  const contact = localStorage.getItem("userContact");
  const userToken = localStorage.getItem("userToken");

  // ğŸš« Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ â†’ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
  if (!contact || !userToken) {
    window.location.href = "../login/login.html";
  }

  // âœ… ØªØ­Ù…ÙŠÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
  async function loadDashboard() {
    document.getElementById("welcome").textContent =
      `ğŸ‘‹ Ø£Ù‡Ù„Ø§Ù‹ ${localStorage.getItem("userName") || ""}`;

    const { data, error } = await supabase
      .from("book_live_sessions")
      .select("*")
      .eq("contact", contact)
      .order("id", { ascending: false })
      .limit(1)
      .maybeSingle();

    if (error || !data) {
      document.getElementById("session-info").innerHTML =
        "<p>âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ø­Ø¬Ø².</p>";
      return;
    }

    // ğŸ§¾ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­ØµØ©
    document.getElementById("session-info").innerHTML = `
      <b>ğŸ“˜ Ø§Ù„Ù…Ø§Ø¯Ø©:</b> ${data.subject || "-"} <br>
      <b>â±ï¸ Ø§Ù„Ù…Ø¯Ø©:</b> ${data.duration || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©"} <br>
      <b>ğŸ’° Ø§Ù„Ø³Ø¹Ø±:</b> ${data.price || 0} Ø¯Ø¬ <br>
      <b>ğŸ“… Ø§Ù„ÙŠÙˆÙ…:</b> ${data.day || "Ø³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ… Ù„Ø§Ø­Ù‚Ù‹Ø§"} <br>
    `;

    const statusEl = document.getElementById("session-status");
    const linksEl = document.getElementById("links-section");
    linksEl.innerHTML = "";

    // âœ… Ø­Ø§Ù„Ø© Ø§Ù„Ø­ØµØ©
    if (data.stat === true) {
      statusEl.innerHTML = `<span class="status confirmed">âœ… ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­ØµØ©!</span>`;
      linksEl.innerHTML += `
        <a href="https://zoom.us" target="_blank" class="btn join">ğŸ¥ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</a>
      `;
    } else if (data.stat === false) {
      statusEl.innerHTML = `<span class="status rejected">âŒ ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø­ØµØ©</span>`;
    } else {
      statusEl.innerHTML = `<span class="status waiting">â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯</span>`;
    }

    // ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª
    if (data.note && data.note.trim() !== "") {
      linksEl.innerHTML += `
        <div class="student-note-box">
          <b>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ:</b>
          <p>${data.note}</p>
        </div>
      `;
    }

    // ğŸ“„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚
    if (data.exercise_file_url && data.exercise_file_url.trim() !== "") {
      linksEl.innerHTML += `
        <a href="${data.exercise_file_url}" target="_blank" class="file-link">
          ğŸ“„ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø±ÙÙ‚
        </a>
      `;
    }
  }

  // ğŸ” Ø²Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©
  document.getElementById("refresh").addEventListener("click", loadDashboard);

  // ğŸšª Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ (Ù…Ø¨Ø§Ø´Ø±)
  const logoutBtn = document.createElement("button");
  logoutBtn.textContent = "ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬";
  logoutBtn.className = "btn logout";
  logoutBtn.style.marginTop = "1.2rem";
  logoutBtn.addEventListener("click", () => {
    localStorage.clear();
    window.location.href = "../login/login.html";
  });

  // â• Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
  document.addEventListener("DOMContentLoaded", () => {
    const container = document.querySelector(".dashboard-container");
    container.appendChild(logoutBtn);
    loadDashboard();
  });
</script>


</body>
</html>
